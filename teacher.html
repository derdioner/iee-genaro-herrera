<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Docente | IEE Genaro Herrera</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- SheetJS for Excel Parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: #f0f7ff;
        }

        .teacher-container {
            max-width: 800px;
            margin: 100px auto 50px;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-dark);
        }

        .form-header i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
        }

        .upload-area {
            border: 2px dashed #00bfff;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            background: #f0faff;
            cursor: pointer;
            transition: 0.3s;
        }

        .upload-area:hover {
            background: #e1f5fe;
        }

        .btn-upload {
            background: #00bfff;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-upload:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
            overflow: hidden;
        }

        .progress-inner {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }

        /* Excel Template Section */
        .excel-section {
            background: #fff8e1;
            border: 1px solid #ffe082;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .excel-info {
            flex: 1;
        }

        .excel-info h4 {
            margin: 0 0 5px 0;
            color: #795548;
        }

        .excel-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #8d6e63;
        }

        .btn-excel {
            background: #2e7d32;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .btn-excel:hover {
            background: #1b5e20;
        }

        /* History Table Styles */
        .history-section {
            margin-top: 50px;
            border-top: 2px solid #eee;
            padding-top: 30px;
        }

        .history-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            color: #555;
            font-weight: 700;
        }

        .btn-delete-item {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-delete-item:hover {
            background: #ff6b81;
        }
    </style>
</head>

<body>
    <header class="main-header" style="height: 70px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="container header-container">
            <div class="logo">
                <img src="images/logo.png" alt="Logo" class="logo-img">
                <div class="logo-text">
                    <h1>INTRANET</h1>
                    <span>Panel Docente</span>
                </div>
            </div>
            <a href="index.html" class="btn btn-secondary" style="padding: 8px 20px;">Cerrar Sesión</a>
        </div>
    </header>

    <div class="teacher-container">
        <div class="form-header">
            <i class="fas fa-cloud-upload-alt"></i>
            <h2>Subir Material Educativo</h2>
            <p>Selecciona el grupo y el archivo que deseas compartir con los padres de familia.</p>
        </div>

        <form id="uploadForm">
            <div class="form-group">
                <label>Título del Material / Tarea:</label>
                <input type="text" id="mTitle" placeholder="Ej: Tarea de Álgebra - Semana 12" required>
            </div>

            <div class="form-group">
                <label>Descripción u Observaciones:</label>
                <textarea id="mDesc" rows="3" placeholder="Instrucciones adicionales para los padres..."></textarea>
            </div>

            <div class="form-row" id="academicSelectGroup">
                <div class="form-group">
                    <label>Nivel:</label>
                    <select id="mLevel" required>
                        <option value="Inicial">Inicial</option>
                        <option value="Primaria">Primaria</option>
                        <option value="Secundaria">Secundaria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Grado:</label>
                    <select id="mGrade" required>
                        <option value="1">1ero</option>
                        <option value="2">2do</option>
                        <option value="3">3ero</option>
                        <option value="4">4to</option>
                        <option value="5">5to</option>
                        <option value="6">6to</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sección:</label>
                    <select id="mSection" required>
                        <option value="A">Sección A</option>
                        <option value="B">Sección B</option>
                        <option value="C">Sección C</option>
                        <option value="D">Sección D</option>
                        <option value="E">Sección E</option>
                        <option value="F">Sección F</option>
                        <option value="G">Sección G</option>
                    </select>
                </div>
            </div>
            <!-- Info box for assigned teacher -->
            <div id="assignedInfo"
                style="display: none; background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c8e6c9; color: #2e7d32; font-weight: 600; text-align: center;">
                <i class="fas fa-info-circle"></i> Material dirigido a: <span id="assignedLabel"></span>
            </div>

            <div class="form-group">
                <label>Archivo (PDF, Imagen, Word):</label>
                <div class="upload-area" onclick="document.getElementById('mFile').click()">
                    <i class="fas fa-file-alt" style="font-size: 2rem; color: #00bfff;"></i>
                    <p id="fileNameDisplay">Haz clic para seleccionar un archivo</p>
                    <input type="file" id="mFile" style="display: none;" required>
                </div>
            </div>

            <div class="progress-bar" id="progBar">
                <div class="progress-inner" id="progInner"></div>
            </div>

            <button type="submit" class="btn-upload" id="uploadBtn">Publicar Material</button>
        </form>

        <!-- Excel Template Section -->
        <div class="excel-section" style="margin-top: 50px; border-top: 2px solid #eee; padding-top: 30px;">
            <div style="font-size: 2.5rem; color: #2e7d32;">
                <i class="fas fa-file-excel"></i>
            </div>
            <div class="excel-info">
                <h4>Comentarios de Avance Educativo</h4>
                <p>Descarga la plantilla, llénala con los comentarios de progreso y súbela aquí para actualizar a los
                    padres.</p>

                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <a href="#" onclick="downloadTemplate()" class="btn-excel">
                        <i class="fas fa-download"></i> Descargar Plantilla
                    </a>
                    <button onclick="document.getElementById('excelFile').click()" class="btn-excel"
                        style="background: #1565c0;">
                        <i class="fas fa-upload"></i> Subir Excel / CSV
                    </button>
                    <input type="file" id="excelFile" style="display: none;" accept=".csv, .xlsx, .xls">
                </div>
                <div id="excelStatus" style="margin-top: 10px; font-size: 0.85rem; font-weight: 600;"></div>
            </div>
        </div>

        <!-- Material History Section -->
        <div class="history-section">
            <h3 style="color: var(--primary-dark);"><i class="fas fa-history"></i> Historial de Materiales Subidos</h3>
            <p style="font-size: 0.85rem; color: #666;">Aquí puedes ver y gestionar los archivos que has compartido.</p>

            <div class="history-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Material</th>
                            <th>Nivel / Aula</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">Cargando historial...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, storage, auth } from './firebase-config.js';
        import { ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { collection, addDoc, serverTimestamp, getDoc, doc, updateDoc, query, where, getDocs, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- GLOBAL TOAST SYSTEM ---
        window.showStatus = (message, type = 'success', duration = 3000) => {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = `toast-msg ${type}`;
            const icons = {
                success: '<i class="fas fa-check-circle toast-icon"></i>',
                error: '<i class="fas fa-exclamation-circle toast-icon"></i>',
                info: '<i class="fas fa-info-circle toast-icon"></i>'
            };
            toast.innerHTML = `${icons[type] || icons.info}<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        };

        let currentTeacherData = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentTeacher = user;
                try {
                    // Fetch profile from staff collection
                    const docData = await getDoc(doc(db, "staff", user.email));
                    if (docData.exists()) {
                        currentTeacherData = docData.data();
                        console.log("Teacher profile loaded:", currentTeacherData);

                        // Auto-fill academic fields
                        if (currentTeacherData.level) {
                            document.getElementById('mLevel').value = currentTeacherData.level;
                            // Trigger change to populate grades
                            document.getElementById('mLevel').dispatchEvent(new Event('change'));
                        }
                        if (currentTeacherData.grade) document.getElementById('mGrade').value = currentTeacherData.grade;
                        if (currentTeacherData.section) document.getElementById('mSection').value = currentTeacherData.section;

                        // Logic refinement: Hide selectors if teacher is Primaria or has fully assigned data
                        const isPrimaria = currentTeacherData.level === 'Primaria';
                        const isSecundaria = currentTeacherData.level === 'Secundaria';

                        if (isPrimaria) {
                            document.getElementById('academicSelectGroup').style.display = 'none';
                            const infoBox = document.getElementById('assignedInfo');
                            const label = document.getElementById('assignedLabel');
                            infoBox.style.display = 'block';
                            label.innerText = `${currentTeacherData.level} - ${currentTeacherData.grade}° Grado "${currentTeacherData.section}"`;
                        } else if (isSecundaria && currentTeacherData.assignments) {
                            // Proyecto 2: For Secondary, we populate the selectors with only assigned classrooms
                            const levelSel = document.getElementById('mLevel');
                            const gradeSel = document.getElementById('mGrade');
                            const sectionSel = document.getElementById('mSection');

                            levelSel.value = 'Secundaria';
                            levelSel.disabled = true; // Level is locked

                            // Filter grades and sections based on assignments
                            updateSecondarySelectors(currentTeacherData.assignments);

                            const infoBox = document.getElementById('assignedInfo');
                            const label = document.getElementById('assignedLabel');
                            infoBox.style.display = 'block';
                            infoBox.style.background = '#e3f2fd';
                            infoBox.style.borderColor = '#bbdefb';
                            infoBox.style.color = '#1976d2';
                            label.innerText = `Panel de Secundaria - Especialidad: ${currentTeacherData.specialties ? currentTeacherData.specialties.join(' / ') : currentTeacherData.specialty}`;
                        }

                        console.log("Academic fields handled for teacher.");
                        fetchTeacherHistory();
                    }
                } catch (err) {
                    console.error("Error fetching teacher profile:", err);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        const mLevel = document.getElementById('mLevel');
        const mGrade = document.getElementById('mGrade');

        // Dynamic Grades
        mLevel.addEventListener('change', () => {
            const level = mLevel.value;
            if (level === 'Inicial') {
                mGrade.innerHTML = '<option value="3">3 Años</option><option value="4">4 Años</option><option value="5">5 Años</option>';
            } else {
                const maxGrade = level === 'Primaria' ? 6 : 5;
                mGrade.innerHTML = '';
                for (let i = 1; i <= maxGrade; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `${i}${i === 1 ? 'ero' : i === 2 ? 'do' : i === 3 ? 'ero' : i === 4 ? 'to' : i === 5 ? 'to' : 'to'}`;
                    mGrade.appendChild(opt);
                }
            }
        });

        // Proyecto 2: Helper to update selectors for Secondary teachers
        function updateSecondarySelectors(assignments) {
            const gradeSel = document.getElementById('mGrade');
            const sectionSel = document.getElementById('mSection');

            // Get unique grades from assignments
            const uniqueGrades = [...new Set(assignments.map(a => a.grade))].sort();

            gradeSel.innerHTML = '';
            uniqueGrades.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = `${g}${g === '1' ? 'ero' : g === '2' ? 'do' : g === '3' ? 'ero' : 'to'} Grado`;
                gradeSel.appendChild(opt);
            });

            const updateSections = () => {
                const selectedGrade = gradeSel.value;
                const relevantSections = assignments
                    .filter(a => a.grade === selectedGrade)
                    .map(a => a.section)
                    .sort();

                sectionSel.innerHTML = '';
                relevantSections.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = `Sección ${s}`;
                    sectionSel.appendChild(opt);
                });
            };

            gradeSel.onchange = updateSections;
            updateSections(); // Initial call
        }

        const fileInput = document.getElementById('mFile');
        const fileDisplay = document.getElementById('fileNameDisplay');

        fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
                fileDisplay.innerText = "Archivo seleccionado: " + fileInput.files[0].name;
                fileDisplay.style.color = "#28a745";
            }
        };

        const form = document.getElementById('uploadForm');
        form.onsubmit = async (e) => {
            e.preventDefault();
            console.log("Submit triggered");

            const file = fileInput.files[0];
            const title = document.getElementById('mTitle').value;
            const desc = document.getElementById('mDesc').value;
            const level = document.getElementById('mLevel').value;
            const grade = document.getElementById('mGrade').value;
            const section = document.getElementById('mSection').value;

            if (!file) {
                showStatus("Por favor selecciona un archivo.", "info");
                return;
            }

            console.log("Data to upload:", { title, level, grade, section, filename: file.name });

            const btn = document.getElementById('uploadBtn');
            const progBar = document.getElementById('progBar');
            const progInner = document.getElementById('progInner');

            btn.disabled = true;
            btn.innerText = "Subiendo archivo...";
            progBar.style.display = "block";
            progInner.style.width = "0%";

            try {
                // 1. Upload to Storage
                const timestamp = Date.now();
                const storagePath = `materials/${level}/${grade}/${section}/${timestamp}_${file.name}`;
                console.log("Storage Path:", storagePath);

                const storageRef = ref(storage, storagePath);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progInner.style.width = progress + "%";
                        console.log("Upload progress:", progress.toFixed(2) + "%");
                    },
                    (error) => {
                        console.error("Storage error:", error);
                        showStatus("Error al subir archivo: " + error.message, "error", 5000);
                        btn.disabled = false;
                        btn.innerText = "Publicar Material";
                    },
                    async () => {
                        try {
                            // 2. Get Download URL
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            console.log("File uploaded, URL:", downloadURL);

                            // 3. Save Metadata to Firestore
                            const payload = {
                                title: title,
                                description: desc,
                                level: level,
                                grade: String(grade), // Ensure string for consistency
                                section: section,
                                fileUrl: downloadURL,
                                fileName: file.name,
                                teacherEmail: currentTeacher ? currentTeacher.email : "Invitado",
                                timestamp: serverTimestamp()
                            };

                            console.log("Saving to Firestore...", payload);
                            await addDoc(collection(db, "materials"), payload);
                            fetchTeacherHistory();

                            showStatus("¡Material publicado con éxito!", "success");
                            form.reset();
                            fileDisplay.innerText = "Haz clic para seleccionar un archivo";
                            fileDisplay.style.color = "#666";
                            progBar.style.display = "none";
                            btn.disabled = false;
                            btn.innerText = "Publicar Material";
                        } catch (fsErr) {
                            console.error("Firestore error:", fsErr);
                            showStatus("Error al guardar: " + fsErr.message, "error", 5000);
                            btn.disabled = false;
                            btn.innerText = "Publicar Material";
                        }
                    }
                );

            } catch (err) {
                console.error("Critical error:", err);
                showStatus("Error crítico: " + err.message, "error", 6000);
                btn.disabled = false;
                btn.innerText = "Publicar Material";
            }
        };

        // --- NEW: EXCEL UPLOAD LOGIC ---
        const excelInput = document.getElementById('excelFile');
        const excelStatus = document.getElementById('excelStatus');

        excelInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            excelStatus.innerText = "Procesando archivo: " + file.name;
            excelStatus.style.color = "#1565c0";

            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const data = evt.target.result;
                    // For better CSV handling with semicolons, we can pass raw: true or use specific parser
                    const workbook = XLSX.read(data, { type: 'binary', codepage: 65001 });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    console.log("Excel JSON Initial rows count:", json.length);

                    let updatedCount = 0;
                    let errorCount = 0;
                    let skipCount = 0;

                    for (let i = 1; i < json.length; i++) {
                        let row = json[i];
                        if (!row || row.length === 0) {
                            skipCount++;
                            continue;
                        }

                        console.log(`Processing Row ${i}:`, row);

                        // Handling the case where the whole row might be in the first cell (CSV semicolon issue)
                        if (row.length === 1 && String(row[0]).includes(';')) {
                            row = String(row[0]).split(';');
                            console.log(`Row ${i} auto-split by semicolon:`, row);
                        }

                        let dni = row[0] ? String(row[0]).trim() : "";
                        let comment = row[2] ? String(row[2]).trim() : "";

                        // Basic check: if DNI looks like a header or is empty, skip
                        if (!dni || dni.toLowerCase().includes("dni")) {
                            console.log(`Row ${i} skipped (Invalid DNI: ${dni})`);
                            skipCount++;
                            continue;
                        }

                        if (dni && comment) {
                            console.log(`Searching for student with DNI: [${dni}]...`);

                            // 1. Try studentDni (standard for students)
                            let q = query(collection(db, "students"), where("studentDni", "==", dni));
                            let snap = await getDocs(q);

                            // 2. Fallback: Try dni field (sometimes used for parent, but might be used for student in legacy)
                            if (snap.empty) {
                                console.log(`No match for studentDni="${dni}". Trying dni="${dni}"...`);
                                q = query(collection(db, "students"), where("dni", "==", dni));
                                snap = await getDocs(q);
                            }

                            // 3. Match numeric DNI (in case it was stored as Number)
                            if (snap.empty && !isNaN(dni) && dni !== "") {
                                const dniNum = Number(dni);
                                console.log(`No match for string. Trying numeric studentDni=${dniNum}...`);
                                q = query(collection(db, "students"), where("studentDni", "==", dniNum));
                                snap = await getDocs(q);
                                if (snap.empty) {
                                    console.log(`Trying numeric dni=${dniNum}...`);
                                    q = query(collection(db, "students"), where("dni", "==", dniNum));
                                    snap = await getDocs(q);
                                }
                            }

                            if (!snap.empty) {
                                console.log(`Match found! Updating ${snap.size} document(s) for DNI ${dni}`);
                                for (const docSnap of snap.docs) {
                                    await updateDoc(doc(db, "students", docSnap.id), {
                                        progressComment: comment,
                                        progressTimestamp: serverTimestamp()
                                    });
                                }
                                updatedCount++;
                            } else {
                                console.warn(`Student NOT found for DNI: [${dni}]. Please verify if this DNI exists in the 'students' collection.`);
                                errorCount++;
                            }
                        } else {
                            console.log(`Row ${i} missing DNI or Comment. DNI: [${dni}], Comment: [${comment}]`);
                            errorCount++;
                        }
                    }

                    const finalMsg = `Proceso completado.\n✅ Actualizados: ${updatedCount}\n❌ Fallos: ${errorCount}\n⚠️ Omitidos: ${skipCount}`;
                    showStatus(finalMsg, errorCount === 0 && skipCount === 0 ? "success" : "info", 6000);
                    excelStatus.innerText = `Resultado: ${updatedCount} exitosos, ${errorCount} fallidos, ${skipCount} omitidos.`;
                    excelStatus.style.color = updatedCount > 0 ? "#28a745" : "orange";
                    excelInput.value = ""; // Clear for next upload

                } catch (err) {
                    console.error("Reader error:", err);
                    showStatus("Error al procesar el archivo: " + err.message, "error", 5000);
                    excelStatus.innerText = "Error al procesar archivo.";
                    excelStatus.style.color = "red";
                }
            };
            reader.readAsBinaryString(file);
        };

        // --- NEW: EXCEL TEMPLATE DOWNLOAD LOGIC (WITH AUTOMATIC STUDENT LIST) ---
        window.downloadTemplate = async () => {
            if (!currentTeacherData) {
                showStatus("Error: No se ha detectado su información académica. Por favor, recargue la página o verifique su perfil.", "error", 6000);
                return;
            }

            const { level, grade, section } = currentTeacherData;
            console.log(`Generating template for: ${level} ${grade}° "${section}"`);

            try {
                // Fetch students matching the teacher's assigned level, grade, and section
                const q = query(
                    collection(db, "students"),
                    where("level", "==", level),
                    where("grade", "==", String(grade)),
                    where("section", "==", section)
                );

                const studentsSnap = await getDocs(q); // Renamed snap to studentsSnap for clarity

                // BOM for Excel UTF-8 compatibility
                const BOM = "\uFEFF";
                let csvContent = "DNI_ESTUDIANTE;NOMBRE_ESTUDIANTE;COMENTARIO_AVANCE_EDUCATIVO;FECHA_REFERENCIA\n";

                if (studentsSnap.empty) {
                    showStatus("Aviso: No se encontraron alumnos registrados en tu aula. Se descargará una plantilla con un ejemplo.", "info", 6000);
                    csvContent += "00000000;Sin Estudiantes Registrados;Escribe aquí el comentario;2025-12-19\n";
                } else {
                    studentsSnap.forEach(doc => {
                        const s = doc.data();
                        const dni = s.studentDni || s.dni || "";
                        const name = s.studentName || s.name || "";
                        csvContent += `${dni};${name};;\n`;
                    });
                }

                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Plantilla_Avance_${level}_${grade}_${section}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log("Template generated successfully.");
            } catch (err) {
                console.error("Template error:", err);
                showStatus("Error al generar la plantilla: " + err.message, "error", 5000);
            }
        };

        // --- NEW: TEACHER MATERIAL HISTORY LOGIC ---
        async function fetchTeacherHistory() {
            const tbody = document.getElementById('historyBody');
            if (!currentTeacher) return;

            try {
                // Try ordered query first
                const q = query(
                    collection(db, "materials"),
                    where("teacherEmail", "==", currentTeacher.email),
                    orderBy("timestamp", "desc")
                );

                const snap = await getDocs(q);
                renderHistoryTable(snap.docs.map(d => ({ id: d.id, ...d.data() })));

            } catch (err) {
                console.warn("Index not ready or missing, using fallback (client-side sort):", err);

                if (err.message.includes("index")) {
                    try {
                        // Fallback: Simple query + client-side sort
                        const qFallback = query(
                            collection(db, "materials"),
                            where("teacherEmail", "==", currentTeacher.email)
                        );
                        const snapFallback = await getDocs(qFallback);

                        const data = snapFallback.docs.map(d => ({ id: d.id, ...d.data() }));
                        data.sort((a, b) => {
                            const tA = a.timestamp ? a.timestamp.seconds : 0;
                            const tB = b.timestamp ? b.timestamp.seconds : 0;
                            return tB - tA;
                        });

                        renderHistoryTable(data);
                    } catch (err2) {
                        console.error("Critical error in history fallback:", err2);
                        tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Error: ${err2.message}</td></tr>`;
                    }
                } else {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Error: ${err.message}</td></tr>`;
                }
            }
        }

        function renderHistoryTable(items) {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Aún no has subido ningún material.</td></tr>';
                return;
            }

            items.forEach(data => {
                const tr = document.createElement('tr');
                const ts = data.timestamp ? new Date(data.timestamp.seconds * 1000) : new Date();
                const dateFmt = `${ts.getDate().toString().padStart(2, '0')}/${(ts.getMonth() + 1).toString().padStart(2, '0')}/${ts.getFullYear()}`;

                tr.innerHTML = `
                     <td>${dateFmt}</td>
                     <td>
                         <strong>${data.title}</strong><br>
                         <small style="color: #666;">${data.fileName || 'Archivo'}</small>
                     </td>
                     <td>${data.level} - ${data.grade}° "${data.section}"</td>
                     <td>
                         <a href="${data.fileUrl}" target="_blank" class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: #eee; color: #333; text-decoration: none; border-radius: 4px; margin-right: 5px;"><i class="fas fa-eye"></i></a>
                         <button class="btn-delete-item" onclick="deleteMaterial('${data.id}', '${data.fileUrl}')"><i class="fas fa-trash"></i></button>
                     </td>
                 `;
                tbody.appendChild(tr);
            });
        }

        window.deleteMaterial = async (id, fileUrl) => {
            if (!confirm("¿Estás seguro de que deseas eliminar este material? Esta acción no se puede deshacer.")) return;

            try {
                // 1. Delete from Firestore
                await deleteDoc(doc(db, "materials", id));

                // 2. Try to delete from Storage (optional, based on URL)
                try {
                    // Extract path from URL if needed, or use the URL directly if Firebase SDK supports it
                    // For simplicity with resumable upload urls, sometimes deleteObject(ref(storage, url)) works
                    const storageRef = ref(storage, fileUrl);
                    await deleteObject(storageRef);
                    console.log("File deleted from storage.");
                } catch (stErr) {
                    console.warn("Storage deletion failed (it might not be a direct storage URL or already deleted):", stErr);
                }

                showStatus("Material eliminado correctamente.", "success");
                fetchTeacherHistory();
            } catch (err) {
                console.error("Error deleting material:", err);
                showStatus("Error al eliminar: " + err.message, "error", 5000);
            }
        };
    </script>
</body>

</html>