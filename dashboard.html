<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intranet | IEE Genaro Herrera</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* Multi-student selector styles */
        #studentSelectorOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 18, 32, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .selector-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .student-card {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            cursor: pointer;
            transition: 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 15px;
            text-align: left;
        }

        .student-card:hover {
            border-color: #00bfff;
            background: #e1f5fe;
        }

        .student-card i {
            font-size: 2rem;
            color: #00bfff;
        }

        .student-card .info h4 {
            margin: 0;
            color: #333;
        }

        .student-card .info p {
            margin: 5px 0 0;
            font-size: 0.85rem;
            color: #666;
        }

        .dashboard-container {
            padding: 120px 20px 50px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .welcome-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 30px;
        }

        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .info-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .info-card h4 {
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .logout-btn {
            background: #ff4757;
            border: none;
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: #ff6b81;
        }

        .boleta-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4) !important;
            filter: brightness(1.1);
        }
    </style>
</head>

<body>
    <!-- Multi-student Selector Overlay -->
    <div id="studentSelectorOverlay">
        <div class="selector-box">
            <h2 style="color: #001220; margin-bottom: 10px;">Â¡Bienvenido de nuevo!</h2>
            <p style="color: #666;">Seleccione al estudiante que desea consultar:</p>
            <div id="studentsListGrid">
                <!-- Students cards here -->
            </div>
            <button onclick="signOut(auth).then(()=>window.location.href='index.html')" class="btn btn-secondary"
                style="margin-top: 20px; width: 100%;">Cerrar SesiÃ³n</button>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header" style="height: 70px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="container header-container">
            <div class="logo">
                <img src="images/logo.png" alt="Logo" class="logo-img">
                <div class="logo-text">
                    <h1>INTRANET</h1>
                    <span>Padres de Familia</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="changeStudentBtn" class="btn"
                    style="display: none; background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                    <i class="fas fa-exchange-alt"></i> Cambiar Hijo
                </button>
                <button id="logoutBtn" class="btn btn-primary logout-btn" style="margin-top: 0; padding: 8px 20px;">
                    Cerrar SesiÃ³n
                </button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="welcome-card">
            <h2>Â¡Hola, <span id="userEmail">Cargando...</span>!</h2>
            <p>Bienvenido a la plataforma de seguimiento acadÃ©mico.</p>
        </div>

        <!-- DEBUG BLOCK: REMOVE AFTER FIXING -->
        <div
            style="background: #333; color: #0f0; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-family: monospace; font-size: 12px; overflow-wrap: break-word;">
            <strong>DEBUG INFO:</strong><br>
            <span id="debugOutput">Esperando datos...</span>
        </div>

        <h3 style="margin-bottom: 20px; color: var(--primary-dark);">InformaciÃ³n del Estudiante</h3>

        <!-- Data Display -->
        <div class="student-info">
            <div class="info-card" style="position: relative;">
                <h4><i class="fas fa-user-graduate"></i> Estudiante</h4>
                <p><strong id="studentName">Cargando...</strong></p>
                <div style="margin-top: 10px; font-size: 0.95rem; line-height: 1.6;">
                    <p><i class="fas fa-id-card" style="color: #3498db; width: 20px;"></i> DNI: <span
                            id="studentDni">--</span></p>
                    <p><i class="fas fa-graduation-cap" style="color: #3498db; width: 20px;"></i> Grado: <span
                            id="studentGrade">--</span></p>
                    <p><i class="fas fa-chalkboard-teacher" style="color: #3498db; width: 20px;"></i> SecciÃ³n: <span
                            id="studentSection">--</span></p>
                </div>
            </div>
            <div class="info-card">
                <h4><i class="fas fa-clipboard-check"></i> Asistencia Anual</h4>
                <p>Asistencias: <strong id="studentAttendance">--%</strong></p>
                <p>Estado: <span id="attendanceStatus">--</span></p>
            </div>
            <div class="info-card">
                <h4><i class="fas fa-star"></i> Rendimiento</h4>

                <!-- Integrated Report Card Option (MOVED HERE) -->
                <div id="reportCardBadge"
                    style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd;">
                    <a href="#" id="reportCardLink" target="_blank" class="boleta-btn"
                        style="display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: 600; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); transition: 0.3s; font-size: 0.9rem;">
                        <i class="fas fa-file-pdf" style="font-size: 1.2rem;"></i>
                        VER BOLETA DE NOTAS
                    </a>
                </div>
                <div id="noReportCardMsg" style="margin-top: 15px; font-size: 0.8rem; color: #999; font-style: italic;">
                    * Boleta aÃºn no disponible.
                </div>
            </div>
            <!-- Progress Comments Section -->
            <div class="info-card" id="progressContainer"
                style="grid-column: 1 / -1; border-left: 5px solid #1565c0; background: #e3f2fd;">
                <h4><i class="fas fa-comment-dots"></i> Avance Educativo (Comentario del Docente)</h4>
                <p id="progressComment"
                    style="font-style: italic; color: #0d47a1; margin-top: 10px; font-size: 1.1rem; line-height: 1.5;">
                    No hay comentarios registrados para este periodo.
                </p>
                <p id="progressDate" style="font-size: 0.8rem; color: #546e7a; margin-top: 10px;"></p>
            </div>


            <!-- Real-time QR Attendance -->
            <div class="info-card" style="grid-column: 1 / -1;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;"><i class="fas fa-clock"></i> Ãšltimas Asistencias (QR)</h4>
                    <button id="viewHistoryBtn" class="btn btn-secondary"
                        style="font-size:0.8rem; padding: 5px 10px;">ðŸ“… Ver Historial Mensual</button>
                </div>
                <ul id="qrList" style="list-style: none; padding: 0;">
                    <li style="padding: 10px; border-bottom: 1px solid #eee; text-align: center; color: #666;">Cargando
                        historial...</li>
                </ul>
            </div>

            <!-- Class Materials Section -->
            <div class="info-card" style="grid-column: 1 / -1; border-left: 5px solid #28a745;">
                <h4 style="color: #1e7e34;"><i class="fas fa-book"></i> Materiales de Clase y Tareas</h4>
                <div id="materialsListWrapper" style="margin-top: 15px;">
                    <ul id="materialsList" style="list-style: none; padding: 0;">
                        <li style="padding: 10px; text-align: center; color: #666;">Cargando materiales...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="historyModal"
        style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
        <div
            style="background-color:white; margin:auto; padding:20px; border-radius:10px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; position:relative;">
            <span onclick="closeModal()"
                style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <h3 style="color: var(--primary-dark); text-align:center; margin-bottom:20px;">Historial de Asistencia</h3>

            <div style="display:flex; gap:10px; margin-bottom:20px; justify-content:center;">
                <input type="month" id="historyMonth" style="padding:8px; border-radius:5px; border:1px solid #ddd;">
                <button id="searchHistoryBtn" class="btn btn-primary" style="padding:8px 15px;">Ver</button>
            </div>

            <table style="width:100%; border-collapse:collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background:#f4f4f4; text-align:left;">
                        <th style="padding:10px;">Fecha</th>
                        <th style="padding:10px;">Hora</th>
                        <th style="padding:10px;">Estado</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- Rows will be added here -->
                </tbody>
            </table>

            <div id="historySummary" style="border-top:1px solid #ddd; padding-top:10px;">
                <!-- Summary Stats -->
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { qrDb } from './firebase-qr-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { collection, query, where, getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const userEmailSpan = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');

        // DEBUG HELPER
        function logDebug(msg) {
            const out = document.getElementById('debugOutput');
            if (out) out.innerHTML += msg + "<br>";
        }

        // Check Authentication Status
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userEmailSpan.textContent = user.email;
                logDebug("Auth OK: " + user.email);

                // Real-time listener for Student Data
                try {
                    const qStudents = query(collection(db, "students"), where("email", "==", user.email));

                    onSnapshot(qStudents, (snapStudents) => {
                        logDebug("Snapshot Rx. Empty? " + snapStudents.empty + ". Size: " + snapStudents.size);

                        let cachedStudents = [];

                        if (snapStudents.empty) {
                            document.querySelector('.student-info').innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No hay datos registrados. ComunÃ­quese con administraciÃ³n.</p>';
                            logDebug("No students found for this email.");
                            return;
                        }

                        snapStudents.forEach(doc => {
                            cachedStudents.push({ id: doc.id, ...doc.data() });
                        });

                        if (cachedStudents.length > 1) {
                            logDebug("Multi-student mode.");
                            // DEBUG: Show details for all
                            cachedStudents.forEach((s, i) => {
                                logDebug(`[${i}] ${s.studentName} URL:${!!s.reportCardUrl}`);
                            });

                            const changeBtn = document.getElementById('changeStudentBtn');
                            if (changeBtn) {
                                changeBtn.style.display = 'inline-block';
                                changeBtn.onclick = () => showStudentSelector(cachedStudents);
                            }

                            const currentDni = document.getElementById('studentDni').innerText;
                            if (currentDni !== '--') {
                                const current = cachedStudents.find(s => s.dni === currentDni || s.studentDni === currentDni);
                                if (current) loadStudentData(current);
                            } else {
                                showStudentSelector(cachedStudents);
                            }
                        } else {
                            logDebug("Single student mode. Loading...");
                            loadStudentData(cachedStudents[0]);
                        }
                    }, (error) => {
                        console.error("Error getting students real-time:", error);
                        logDebug("Snapshot Error: " + error.message);
                    });

                } catch (error) {
                    console.error("Error setting up listener:", error);
                    logDebug("Setup Error: " + error.message);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        async function showStudentSelector(students) {
            const overlay = document.getElementById('studentSelectorOverlay');
            const grid = document.getElementById('studentsListGrid');
            grid.innerHTML = '';
            overlay.style.display = 'flex';

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                            <i class="fas fa-user-graduate"></i>
                            <div class="info">
                                <h4>${student.studentName}</h4>
                                <p>${student.grade}Â° Grado ${student.section}</p>
                            </div>
                        `;
                card.onclick = () => {
                    overlay.style.display = 'none';
                    loadStudentData(student);
                };
                grid.appendChild(card);
            });
        }

        async function loadStudentData(data) {
            document.getElementById('studentName').textContent = data.studentName;
            document.getElementById('studentDni').textContent = data.dni || "No registrado";
            document.getElementById('studentGrade').textContent = data.grade;
            document.getElementById('studentSection').textContent = data.section;
            document.getElementById('studentAttendance').textContent = data.attendance + '%';
            document.getElementById('studentAverage').textContent = data.average;
            document.getElementById('studentRank').textContent = data.rank + 'Â°';

            // DEBUG POPULATION
            const debugOut = document.getElementById('debugOutput');
            debugOut.innerHTML = `
                ID: ${data.id}<br>
                DNI: ${data.dni || data.studentDni || 'N/A'} (Type: ${typeof (data.dni || data.studentDni)})<br>
                Grade: "${data.grade}" (Type: ${typeof data.grade})<br>
                Section: "${data.section}" (Type: ${typeof data.section})<br>
                ReportUrl: ${data.reportCardUrl ? data.reportCardUrl.substring(0, 30) + '...' : 'UNDEFINED'}
            `;

            const att = parseInt(data.attendance);
            const statusSpan = document.getElementById('attendanceStatus');
            if (att >= 90) { statusSpan.textContent = 'Excelente'; statusSpan.style.color = 'green'; }
            else if (att >= 70) { statusSpan.textContent = 'Regular'; statusSpan.style.color = 'orange'; }
            else { statusSpan.textContent = 'CrÃ­tico'; statusSpan.style.color = 'red'; }

            if (data.reportCardUrl) {
                document.getElementById('reportCardBadge').style.display = 'block';
                document.getElementById('noReportCardMsg').style.display = 'none';
                document.getElementById('reportCardLink').href = data.reportCardUrl;
            } else {
                document.getElementById('reportCardBadge').style.display = 'none';
                document.getElementById('noReportCardMsg').style.display = 'block';
            }

            // --- NEW: PROGRESS COMMENT HANDLING ---
            const progressComment = document.getElementById('progressComment');
            const progressDate = document.getElementById('progressDate');
            if (data.progressComment) {
                progressComment.innerText = data.progressComment;
                if (data.progressTimestamp) {
                    const ts = new Date(data.progressTimestamp.seconds * 1000);
                    progressDate.innerText = "Actualizado el: " + ts.toLocaleDateString() + " " + ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    progressDate.innerText = "";
                }
            } else {
                progressComment.innerText = "No hay comentarios registrados para este periodo.";
                progressDate.innerText = "";
            }

            if (data.dni) {
                fetchQrAttendance(data.dni);
                document.getElementById('viewHistoryBtn').onclick = () => openHistoryModal(data.dni);
            } else {
                document.getElementById('qrList').innerHTML = '<li style="padding: 10px; text-align: center;">DNI no configurado.</li>';
                document.getElementById('viewHistoryBtn').style.display = 'none';
            }

            fetchConductReportsMulti(data.id); // Optimized for multi-child
            fetchMaterials(data.grade, data.section);
        }

        // --- MONTHLY HISTORY LOGIC ---
        const modal = document.getElementById('historyModal');
        const monthInput = document.getElementById('historyMonth');
        let currentStudentDni = null;

        // Make closeModal global for HTML access
        window.closeModal = function () {
            modal.style.display = 'none';
        }

        // Close on click outside
        window.onclick = function (event) {
            if (event.target == modal) {
                window.closeModal();
            }
        }

        // Define open function (scoped)
        function openHistoryModal(dni) {
            console.log("Opening history for:", dni);
            currentStudentDni = dni;
            modal.style.display = 'flex';

            // Default to current month
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
            monthInput.value = monthStr;

            loadMonthlyHistory();
        }

        document.getElementById('searchHistoryBtn').addEventListener('click', loadMonthlyHistory);

        async function loadMonthlyHistory() {
            if (!currentStudentDni) return;

            const tbody = document.getElementById('historyTableBody');
            const summaryDiv = document.getElementById('historySummary');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Cargando datos...</td></tr>';
            summaryDiv.innerHTML = '';

            try {
                // Fetch records (limit 300 to cover full month/year)
                const q = query(
                    collection(qrDb, "attendance"),
                    where("dni", "==", currentStudentDni),
                    limit(300)
                );

                const snap = await getDocs(q);

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay registros histÃ³ricos.</td></tr>';
                    return;
                }

                // Filter Client-side by Month
                const selectedMonth = monthInput.value; // YYYY-MM
                if (!selectedMonth) return;

                const docs = [];
                snap.forEach(d => docs.push(d.data()));

                const filtered = docs.filter(r => {
                    if (!r.timestamp) return false;
                    const date = new Date(r.timestamp.seconds * 1000);
                    const rMonth = date.toISOString().slice(0, 7);
                    return rMonth === selectedMonth;
                });

                // Sort Descending
                filtered.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Sin registros en este mes.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                let lateCount = 0;
                let presentCount = 0;

                filtered.forEach(r => {
                    const date = new Date(r.timestamp.seconds * 1000);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    const fullDate = `${day}/${month}/${year}`;
                    const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    const status = r.status || "registrado";
                    if (status === 'Tardanza') lateCount++; else presentCount++;
                    const color = (status === 'Puntual') ? 'green' : (status === 'Tardanza' ? 'red' : '#666');

                    const row = `
                        <tr>
                            <td>${fullDate}</td>
                            <td>${time}</td>
                            <td><span style="color: ${color}; font-weight: bold;">${status}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                summaryDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-around; margin-top:10px; font-size: 0.9em;">
                        <span style="color:green;">âœ… Puntuales: ${presentCount}</span>
                        <span style="color:red;">ðŸš¨ Tardanzas: ${lateCount}</span>
                    </div>
                `;

            } catch (e) {
                console.error("Error history:", e);
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">Error: ${e.message}</td></tr>`;
            }
        }

        async function fetchQrAttendance(dni) {
            const list = document.getElementById('qrList');
            try {
                // Correct Collection Name from QR Project: 'attendance'
                // Field Name for DNI in QR Project: 'dni' (lowercase)
                // Field for timestamp: 'timestamp'
                const q = query(
                    collection(qrDb, "attendance"),
                    where("dni", "==", dni),
                    orderBy("timestamp", "desc"),
                    limit(5)
                );

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    list.innerHTML = '<li style="padding: 10px; text-align: center;">No se encontraron registros de asistencia recientes.</li>';
                    return;
                }

                list.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const r = doc.data();
                    // QR App Fields: displayDate, displayTime, status
                    const dateStr = r.displayDate + ' ' + r.displayTime;
                    const status = r.status || "registrado";
                    const statusColor = (status === 'Puntual') ? 'green' : (status === 'Tardanza' ? 'red' : '#666');

                    const li = document.createElement('li');
                    li.style.padding = '10px';
                    li.style.borderBottom = '1px solid #eee';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.innerHTML = `<span>ðŸ“… ${dateStr}</span> <span style="color: ${statusColor}; font-weight: bold;">${status}</span>`;
                    list.appendChild(li);
                });

            } catch (error) {
                console.warn("Error fetching QR data (Attempt 1 - Indexed):", error);

                // FALLBACK: If Index fails, try simple query (Client-side Sort)
                // This prevents the "Requires Index" blocker
                try {
                    console.log("Intentando Fallback (Sin OrderBy)...");
                    const qFallback = query(
                        collection(qrDb, "attendance"),
                        where("dni", "==", dni),
                        limit(10)
                    );

                    const snapFallback = await getDocs(qFallback);

                    if (snapFallback.empty) {
                        list.innerHTML = '<li style="padding: 10px; text-align: center;">No se encontraron registros reciente (Fallback).</li>';
                        return;
                    }

                    // Client-side Sort
                    const docs = [];
                    snapFallback.forEach(d => docs.push(d.data()));
                    docs.sort((a, b) => {
                        // Sort by timestamp desc (if exists)
                        const tA = a.timestamp ? a.timestamp.seconds : 0;
                        const tB = b.timestamp ? b.timestamp.seconds : 0;
                        return tB - tA;
                    });

                    list.innerHTML = '';
                    docs.slice(0, 5).forEach((r) => {
                        const dateStr = r.displayDate + ' ' + r.displayTime;
                        const status = r.status || "registrado";
                        const statusColor = (status === 'Puntual') ? 'green' : (status === 'Tardanza' ? 'red' : '#666');

                        const li = document.createElement('li');
                        li.style.padding = '10px';
                        li.style.borderBottom = '1px solid #eee';
                        li.style.display = 'flex';
                        li.style.justifyContent = 'space-between';
                        li.innerHTML = `<span>ðŸ“… ${dateStr}</span> <span style="color: ${statusColor}; font-weight: bold;">${status}</span>`;
                        list.appendChild(li);
                    });

                } catch (e2) {
                    console.error("Error Fallback:", e2);
                    list.innerHTML = `<li style="padding: 10px; text-align: center; color: red;">Error: ${e2.message}</li>`;
                }
            }
        }

        async function fetchMaterials(grade, section) {
            const list = document.getElementById('materialsList');
            // Reset list to loading state if called again
            list.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">Cargando materiales...</li>';

            try {
                // FORCE String type for grade to match teacher upload format
                const strGrade = String(grade);

                console.log(`Fetching materials for Grade: "${strGrade}" Section: "${section}"`);

                // SIMPLIFIED QUERY: No orderBy/limit to avoid Index Requirements
                // We fetch all for this class and sort client-side.
                const q = query(
                    collection(db, "materials"),
                    where("grade", "==", strGrade),
                    where("section", "==", section)
                );

                const snap = await getDocs(q);

                if (snap.empty) {
                    list.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">No hay materiales o tareas publicadas para este grado.</li>';
                    return;
                }

                // Client-side extraction and sorting
                const materials = [];
                snap.forEach(doc => {
                    materials.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp desc (newest first)
                materials.sort((a, b) => {
                    const tA = a.timestamp ? a.timestamp.seconds : 0;
                    const tB = b.timestamp ? b.timestamp.seconds : 0;
                    return tB - tA;
                });

                // Render (optional: limit to 20 recent)
                list.innerHTML = '';
                materials.slice(0, 50).forEach(data => {
                    const ts = data.timestamp ? new Date(data.timestamp.seconds * 1000) : new Date();
                    const dateFmt = `${ts.getDate().toString().padStart(2, '0')}/${(ts.getMonth() + 1).toString().padStart(2, '0')}/${ts.getFullYear()}`;

                    const li = document.createElement('li');
                    li.style.padding = '15px';
                    li.style.borderBottom = '1px solid #eee';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.style.gap = '15px';

                    li.innerHTML = `
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:var(--primary-dark);">${data.title}</div>
                            <div style="font-size:0.85em; color:#666;">${data.description || 'Sin descripciÃ³n'}</div>
                            <div style="font-size:0.8em; color:#999; margin-top:5px;">Publicado: ${dateFmt} â€¢ Por: ${data.teacherName || 'Docente'}</div>
                        </div>
                        <a href="${data.fileUrl}" target="_blank" class="btn btn-primary" style="padding: 5px 12px; font-size: 0.8rem; text-decoration: none; color: white;">
                           <i class="fas fa-download"></i> Ver
                        </a>
                    `;
                    list.appendChild(li);
                });

            } catch (error) {
                console.error("Error fetching materials:", error);
                list.innerHTML = `<li style="color:red; text-align:center;">Error al cargar materiales: ${error.message}</li>`;
            }
        }

        async function fetchConductReportsMulti(studentDocId) {
            const list = document.getElementById('conductList');
            try {
                // Fetch from the specific student document's sub-collection
                const q = query(
                    collection(db, "students", studentDocId, "conduct"),
                    orderBy("timestamp", "desc")
                );
                const snap = await getDocs(q);

                if (snap.empty) {
                    list.innerHTML = '<li style="padding: 10px; text-align: center;">No registra incidencias de conducta.</li>';
                    return;
                }

                list.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.style.padding = '10px';
                    li.style.borderBottom = '1px solid #eee';
                    li.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold; color:#d9534f;">${data.type}</span>
                            <span style="font-size:0.8em; color:#666;">${data.date}</span>
                        </div>
                        <p style="margin:5px 0 0; font-size:0.9em; color:#333;">${data.description}</p>
                    `;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error("Error fetching conduct reports:", error);
                list.innerHTML = `<li style="color:red; text-align:center;">Error al cargar reportes.</li>`;
            }
        }

        async function fetchConductReports(email) {
            const list = document.getElementById('conductList');
            try {
                // Subcollection 'conduct'
                const q = query(
                    collection(db, "students", email, "conduct"),
                    orderBy("date", "desc"),
                    limit(20)
                );

                const snap = await getDocs(q);

                if (snap.empty) {
                    list.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">No hay reportes de conducta registrados.</li>';
                    return;
                }

                list.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const dateParts = data.date.split('-'); // YYYY-MM-DD
                    const dateFmt = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

                    // Style based on type
                    let color = '#333';
                    let icon = 'fa-info-circle';
                    if (data.type === 'MÃ©rito') { color = 'green'; icon = 'fa-star'; }
                    else if (data.type === 'Tardanza') { color = 'orange'; icon = 'fa-clock'; }
                    else if (data.type === 'Indisciplina') { color = 'red'; icon = 'fa-times-circle'; }

                    const li = document.createElement('li');
                    li.style.padding = '15px';
                    li.style.borderBottom = '1px solid #eee';
                    li.style.display = 'flex';
                    li.style.flexDirection = 'column';
                    li.style.gap = '5px';

                    li.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span style="color: ${color};"><i class="fas ${icon}"></i> ${data.type}</span>
                            <span style="font-size:0.9em; color:#666;">${dateFmt}</span>
                        </div>
                        <p style="margin:0; font-size:0.95em;">${data.description}</p>
                    `;
                    list.appendChild(li);
                });

            } catch (error) {
                console.error("Error fetching conduct:", error);

                // Fallback if index is missing
                if (error.message.includes("index")) {
                    console.log("Index missing, trying fallback...");
                    try {
                        const q2 = query(collection(db, "students", email, "conduct"), limit(20));
                        const snap2 = await getDocs(q2);
                        if (snap2.empty) {
                            list.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">No hay reportes de conducta registrados.</li>';
                            return;
                        }

                        const docs = [];
                        snap2.forEach(d => docs.push(d.data()));
                        // Client sort
                        docs.sort((a, b) => new Date(b.date) - new Date(a.date));

                        list.innerHTML = '';
                        docs.forEach(data => {
                            const dateParts = data.date.split('-');
                            const dateFmt = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                            let color = '#333';
                            if (data.type === 'MÃ©rito') color = 'green';
                            else if (data.type === 'Tardanza') color = 'orange';
                            else if (data.type === 'Indisciplina') color = 'red';

                            const li = document.createElement('li');
                            li.style.padding = '15px';
                            li.style.borderBottom = '1px solid #eee';
                            li.innerHTML = `
                                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                                    <span style="color: ${color};">${data.type}</span>
                                    <span style="font-size:0.9em; color:#666;">${dateFmt}</span>
                                </div>
                                <p style="margin:0;">${data.description}</p>
                             `;
                            list.appendChild(li);
                        });

                    } catch (e2) {
                        list.innerHTML = `<li style="color:red; text-align:center;">Error cargando reportes.</li>`;
                    }
                } else {
                    list.innerHTML = `<li style="color:red; text-align:center;">Error: ${error.message}</li>`;
                }
            }
        }

        // Logout Functionality
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error("Error al cerrar sesiÃ³n:", error);
            });
        });
    </script>
</body>

</html>