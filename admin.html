<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | IEE Genaro Herrera</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #f4f4f4;
        }

        .admin-container {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        h2 {
            color: var(--primary-dark);
            text-align: center;
            margin-bottom: 30px;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <h2>Panel de Administraci贸n de Conducta</h2>
        <div id="successMsg" class="success-msg">隆Datos guardados correctamente!</div>

        <form id="dataForm">
            <!-- Link to Parent -->
            <div class="form-group">
                <label>Correo del Padre (Usuario):</label>
                <input type="email" id="parentEmail" placeholder="ej: padre@prueba.com" required>
                <small>Este correo debe ser el mismo que usa el padre para ingresar.</small>
            </div>

        </form>
        </form>

        <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">

        <!-- Conduct Control Section -->
        <div id="conductSection"
            style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 1px solid #ffeeba;">
            <h3 style="color: #856404; margin-bottom: 15px;"> Control de Conducta / Auxiliar</h3>
            <p style="font-size: 0.9em; margin-bottom: 15px;">Aqu铆 puede registrar incidencias, observaciones o m茅ritos
                para el estudiante actual.</p>

            <form id="conductForm">
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="cDate" required>
                </div>
                <div class="form-group">
                    <label>Tipo de Reporte:</label>
                    <select id="cType">
                        <option value="Observaci贸n">Observaci贸n (General)</option>
                        <option value="Tardanza">Tardanza Reiterada</option>
                        <option value="Indisciplina">Indisciplina</option>
                        <option value="Falta de Tareas">Falta de Tareas</option>
                        <option value="M茅rito">M茅rito / Felicitaci贸n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Detalle / Descripci贸n:</label>
                    <textarea id="cDesc" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                        placeholder="Describa el incidente o motivo..." required></textarea>
                </div>
                <button type="submit" class="btn btn-full" style="background: #e0a800; border: none;">Registrar
                    Reporte</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { db, storage } from './firebase-config.js';
        import { qrDb } from './firebase-qr-config.js';
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { qrDb } from './firebase-qr-config.js';
        import { doc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const form = document.getElementById('dataForm');
        const msg = document.getElementById('successMsg');
        // Form logic removed as per user request to simplify UI
        // Form logic removed as per user request to simplify UI
        form.addEventListener('submit', (e) => e.preventDefault());

        // --- Conduct Form Logic ---
        const conductForm = document.getElementById('conductForm');
        conductForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const parentEmail = document.getElementById('parentEmail').value.toLowerCase().trim();
            if (!parentEmail) {
                alert("Por favor, ingrese el Correo del Padre arriba primero.");
                return;
            }

            const date = document.getElementById('cDate').value;
            const type = document.getElementById('cType').value;
            const desc = document.getElementById('cDesc').value;

            const btn = conductForm.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Registrando...';
            btn.disabled = true;

            try {
                // Add to sub-collection "conduct"
                await addDoc(collection(db, "students", parentEmail, "conduct"), {
                    date: date,
                    type: type,
                    description: desc,
                    timestamp: new Date()
                });

                alert("Reporte de conducta registrado exitosamente.");
                conductForm.reset();
                // Reset date to today
                document.getElementById('cDate').valueAsDate = new Date();

            } catch (error) {
                console.error("Error adding conduct report: ", error);
                alert("Error al registrar: " + error.message);
            }

            btn.innerText = originalText;
            btn.disabled = false;
        });

        // Initialize date picker to today
        document.getElementById('cDate').valueAsDate = new Date();
    </script>
</body>

</html>