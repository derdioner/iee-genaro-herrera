<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | IEE Genaro Herrera</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel Processing (CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #f4f4f4;
        }

        .admin-container {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        h2 {
            color: var(--primary-dark);
            text-align: center;
            margin-bottom: 30px;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <h2>Panel de Administraci贸n de Conducta</h2>
        <div id="successMsg" class="success-msg">隆Datos guardados correctamente!</div>

        <form id="dataForm">
            <!-- Link to Parent -->
            <div class="form-group">
                <label>Correo del Padre (Usuario):</label>
                <input type="email" id="parentEmail" placeholder="ej: padre@prueba.com" required>
                <small>Este correo debe ser el mismo que usa el padre para ingresar.</small>
            </div>

        </form>
        </form>

        <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">

        <!-- Conduct Control Section -->
        <div id="conductSection"
            style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 1px solid #ffeeba;">
            <h3 style="color: #856404; margin-bottom: 15px;"> Control de Conducta / Auxiliar</h3>
            <p style="font-size: 0.9em; margin-bottom: 15px;">Aqu铆 puede registrar incidencias, observaciones o m茅ritos
                para el estudiante actual.</p>

            <form id="conductForm">
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="cDate" required>
                </div>
                <div class="form-group">
                    <label>Tipo de Reporte:</label>
                    <select id="cType">
                        <option value="Observaci贸n">Observaci贸n (General)</option>
                        <option value="Tardanza">Tardanza Reiterada</option>
                        <option value="Indisciplina">Indisciplina</option>
                        <option value="Falta de Tareas">Falta de Tareas</option>
                        <option value="M茅rito">M茅rito / Felicitaci贸n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Detalle / Descripci贸n:</label>
                    <textarea id="cDesc" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                        placeholder="Describa el incidente o motivo..." required></textarea>
                </div>
                <button type="submit" class="btn btn-full" style="background: #e0a800; border: none;">Registrar
                    Reporte</button>
            </form>
        </div>

        <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #666;">

        <!-- Bulk Upload Section -->
        <div id="bulkSection"
            style="background: #e9ecef; padding: 20px; border-radius: 10px; border: 1px solid #ced4da;">
            <h3 style="color: #495057; margin-bottom: 15px;"> Carga Masiva (Excel)</h3>
            <p style="font-size: 0.9em; margin-bottom: 20px;">Use esta opci贸n para cargar reportes de toda el aula a la
                vez.</p>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button type="button" id="downloadTplBtn"
                    style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                     Descargar Plantilla
                </button>
            </div>

            <div class="form-group">
                <label>Subir Archivo (.xlsx):</label>
                <input type="file" id="bulkFile" accept=".xlsx, .xls">
            </div>

            <button type="button" id="processBtn"
                style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                 Procesar Excel
            </button>

            <!-- Console Log -->
            <div id="consoleLog"
                style="margin-top: 20px; background: #333; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; height: 150px; overflow-y: auto; font-size: 0.85rem; display: none;">
                > Esperando archivo...
            </div>
        </div>
    </div>

    <script type="module">
        import { db, storage } from './firebase-config.js';
        import { qrDb } from './firebase-qr-config.js';
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { qrDb } from './firebase-qr-config.js';
        import { doc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const form = document.getElementById('dataForm');
        const msg = document.getElementById('successMsg');
        // Form logic removed as per user request to simplify UI
        // Form logic removed as per user request to simplify UI
        form.addEventListener('submit', (e) => e.preventDefault());

        // --- Conduct Form Logic ---
        const conductForm = document.getElementById('conductForm');
        conductForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const parentEmail = document.getElementById('parentEmail').value.toLowerCase().trim();
            if (!parentEmail) {
                alert("Por favor, ingrese el Correo del Padre arriba primero.");
                return;
            }

            const date = document.getElementById('cDate').value;
            const type = document.getElementById('cType').value;
            const desc = document.getElementById('cDesc').value;

            const btn = conductForm.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Registrando...';
            btn.disabled = true;

            try {
                // Add to sub-collection "conduct"
                await addDoc(collection(db, "students", parentEmail, "conduct"), {
                    date: date,
                    type: type,
                    description: desc,
                    timestamp: new Date()
                });

                alert("Reporte de conducta registrado exitosamente.");
                conductForm.reset();
                // Reset date to today
                document.getElementById('cDate').valueAsDate = new Date();

            } catch (error) {
                console.error("Error adding conduct report: ", error);
                alert("Error al registrar: " + error.message);
            }

            btn.innerText = originalText;
            btn.disabled = false;
        });

        // Initialize date picker to today
        document.getElementById('cDate').valueAsDate = new Date();

        // --- BULK UPLOAD LOGIC ---

        // 1. Download Template
        document.getElementById('downloadTplBtn').addEventListener('click', () => {
            if (typeof XLSX === 'undefined') {
                alert("Error: La librer铆a de Excel no se carg贸 correctamente. Verifique su conexi贸n a internet.");
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const ws_data = [
                    ["DNI", "TIPO", "DETALLE"], // Header
                    ["12345678", "M茅rito", "Participaci贸n destacada en clase"], // Example 1
                    ["87654321", "Tardanza", "Lleg贸 15 minutos tarde"]  // Example 2
                ];
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Reportes");
                XLSX.writeFile(wb, "Plantilla_Conducta_GH.xlsx");
            } catch (e) {
                console.error("Error creating excel:", e);
                alert("Error generando la plantilla: " + e.message);
            }
        });

        // 2. Process File
        document.getElementById('processBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('bulkFile');
            const logBox = document.getElementById('consoleLog');

            if (fileInput.files.length === 0) return alert("Seleccione un archivo primero.");

            const file = fileInput.files[0];
            const reader = new FileReader();

            // UI Reset
            logBox.style.display = 'block';
            logBox.innerHTML = '> Iniciando lectura de archivo...<br>';
            const btn = document.getElementById('processBtn');
            btn.disabled = true;
            btn.style.opacity = '0.7';

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    logBox.innerHTML += `> Filas encontradas: ${jsonData.length}<br>`;
                    logBox.innerHTML += `> Procesando... (No cierre la ventana)<br>--------------------------<br>`;

                    let successCount = 0;
                    let failCount = 0;

                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const dni = row.DNI ? row.DNI.toString().trim() : null;
                        const type = row.TIPO || "Observaci贸n";
                        const desc = row.DETALLE || "Sin detalles";

                        if (!dni) {
                            logBox.innerHTML += `<span style="color:orange;">[Fila ${i + 2}] Saltada: Sin DNI</span><br>`;
                            continue;
                        }

                        // Reverse Lookup: Find parent email by DNI
                        try {
                            const q = query(collection(db, "students"), where("dni", "==", dni), limit(1));
                            const snap = await getDocs(q);

                            if (snap.empty) {
                                logBox.innerHTML += `<span style="color:red;">[${dni}] Error: No registrado en Intranet (Sin Tutor)</span><br>`;
                                failCount++;
                            } else {
                                const parentDoc = snap.docs[0];
                                const parentEmail = parentDoc.id; // Correct ID

                                // Add Conduct Report
                                await addDoc(collection(db, "students", parentEmail, "conduct"), {
                                    date: new Date().toISOString().split('T')[0], // Today
                                    type: type,
                                    description: desc,
                                    timestamp: new Date(),
                                    method: 'bulk_excel'
                                });

                                logBox.innerHTML += `<span style="color:#0f0;">[${dni}] OK: Registrado a ${parentEmail}</span><br>`;
                                successCount++;
                            }
                        } catch (err) {
                            logBox.innerHTML += `<span style="color:red;">[${dni}] Error DB: ${err.message}</span><br>`;
                            failCount++;
                        }

                        // Scroll to bottom
                        logBox.scrollTop = logBox.scrollHeight;
                    }

                    logBox.innerHTML += `--------------------------<br>`;
                    logBox.innerHTML += `> FINALIZADO. xitos: ${successCount} | Fallos: ${failCount}<br>`;
                    alert(`Proceso completado.\nExitosos: ${successCount}\nFallidos: ${failCount}`);

                } catch (err) {
                    console.error(err);
                    alert("Error cr铆tico leyendo el Excel: " + err.message);
                }

                btn.disabled = false;
                btn.style.opacity = '1';
            };

            reader.readAsArrayBuffer(file);
        });
    </script>
</body>

</html>