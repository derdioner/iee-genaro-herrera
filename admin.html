<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | IEE Genaro Herrera</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel Processing (CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: #f4f4f4;
            display: none;
            font-family: 'Montserrat', sans-serif;
        }

        .admin-container {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        h2,
        h3 {
            color: #2c3e50;
            text-align: center;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Script de Seguridad -->
    <script type="module">
        import { auth } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === '45446130@genaroherrera.edu.pe') {
                document.body.style.display = 'block';
            } else {
                alert("Acceso denegado. Se requiere cuenta de Administrador Maestro.");
                window.location.href = 'index.html';
            }
        });

        window.logoutAdmin = () => {
            signOut(auth).then(() => window.location.href = 'index.html');
        };
    </script>

    <header
        style="background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="images/logo.png" alt="Logo" style="height: 50px;">
            <h1 style="font-size: 1.4rem; color: #2c3e50; margin: 0;">Panel Maestro</h1>
        </div>
        <button onclick="logoutAdmin()" class="btn btn-secondary" style="padding: 10px 20px;">Cerrar Sesi贸n</button>
    </header>

    <div class="admin-container">
        <h2>Panel de Gesti贸n Administrativa</h2>
        <div id="successMsg" class="success-msg">隆Datos guardados correctamente!</div>

        <!-- User Management Section -->
        <div id="userManagementSection"
            style="background: #eef2f7; padding: 20px; border-radius: 10px; border: 1px solid #d1d9e6; margin-bottom: 30px;">
            <h3 style="color: #2c3e50; margin-bottom: 15px;"><i class="fas fa-user-plus"></i> Gesti贸n de Usuarios e
                Intranet</h3>
            <p style="font-size: 0.9em; margin-bottom: 15px;">Use este formulario para registrar nuevos Padres o
                Docentes y permitirles el acceso con su DNI.</p>

            <form id="userForm">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label id="labelDni">DNI (Acceso):</label>
                        <input type="text" id="uDni" maxlength="8" placeholder="8 d铆gitos" required>
                    </div>
                    <div class="form-group">
                        <label>Rol en el Sistema:</label>
                        <select id="uRole" required>
                            <option value="students">Padre de Familia</option>
                            <option value="staff">Docente / Personal</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label id="labelName">Nombre Completo:</label>
                    <input type="text" id="uName" placeholder="Ej: Juan P茅rez Lopez" required>
                </div>
                <div class="form-group">
                    <label>Asignar Contrase帽a Inicial:</label>
                    <input type="text" id="uPass" placeholder="Ej: 123456" required>
                    <small>Esta ser谩 la clave que usar谩 el usuario para su primer ingreso.</small>
                </div>

                <!-- dynamic fields for parents -->
                <div id="parentFields" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Grado del Hijo:</label>
                        <select id="uGrade">
                            <option value="1">1ero</option>
                            <option value="2">2do</option>
                            <option value="3">3ero</option>
                            <option value="4">4to</option>
                            <option value="5">5to</option>
                            <option value="6">6to</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Secci贸n del Hijo:</label>
                        <select id="uSection">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="nica">nica</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1; margin-top: -10px;">
                        <label>DNI del Estudiante (Hijo):</label>
                        <input type="text" id="uStudentDni" maxlength="8" placeholder="8 d铆gitos del ni帽o">
                    </div>
                </div>

                <button type="submit" class="btn btn-full"
                    style="background: #3498db; border: none; font-weight: bold; width: 100%; padding: 12px; color: white; border-radius: 5px; cursor: pointer; margin-top: 15px;">Registrar
                    Usuario</button>
            </form>
        </div>

        <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">

        <!-- Conduct Control Section -->
        <div id="conductSection"
            style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 1px solid #ffeeba;">
            <h3 style="color: #856404; margin-bottom: 15px;"> Control de Conducta / Auxiliar</h3>
            <p style="font-size: 0.9em; margin-bottom: 15px;">Aqu铆 puede registrar incidencias, observaciones o
                m茅ritos
                para el estudiante actual.</p>

            <form id="conductForm">
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="cDate" required>
                </div>
                <div class="form-group">
                    <label>Tipo de Reporte:</label>
                    <select id="cType">
                        <option value="Observaci贸n">Observaci贸n (General)</option>
                        <option value="Tardanza">Tardanza Reiterada</option>
                        <option value="Indisciplina">Indisciplina</option>
                        <option value="Falta de Tareas">Falta de Tareas</option>
                        <option value="M茅rito">M茅rito / Felicitaci贸n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Detalle / Descripci贸n:</label>
                    <textarea id="cDesc" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                        placeholder="Describa el incidente o motivo..." required></textarea>
                </div>
                <button type="submit" class="btn btn-full" style="background: #e0a800; border: none;">Registrar
                    Reporte</button>
            </form>
        </div>

        <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #666;">

        <!-- Bulk Upload Section -->
        <div id="bulkSection"
            style="background: #e9ecef; padding: 20px; border-radius: 10px; border: 1px solid #ced4da;">
            <h3 style="color: #495057; margin-bottom: 15px;"> Carga Masiva (Excel)</h3>
            <p style="font-size: 0.9em; margin-bottom: 20px;">Use esta opci贸n para cargar reportes de toda el aula a
                la
                vez.</p>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button type="button" id="downloadTplBtn"
                    style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                     Descargar Plantilla
                </button>
            </div>

            <div class="form-group">
                <label>Subir Archivo (.csv o .xlsx):</label>
                <input type="file" id="bulkFile" accept=".csv, .xlsx, .xls">
            </div>

            <button type="button" id="processBtn"
                style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                 Procesar Excel
            </button>

            <!-- Console Log -->
            <div id="consoleLog"
                style="margin-top: 20px; background: #333; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; height: 150px; overflow-y: auto; font-size: 0.85rem; display: none;">
                > Esperando archivo...
            </div>
        </div>
    </div>

    <script type="module">
        import { db, storage } from './firebase-config.js';
        import { doc, setDoc, addDoc, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { qrDb } from './firebase-qr-config.js';

        const userForm = document.getElementById('userForm');
        const roleSelect = document.getElementById('uRole');
        const parentFields = document.getElementById('parentFields');

        // Toggle fields based on role
        roleSelect.addEventListener('change', () => {
            const isParent = roleSelect.value === 'students';
            parentFields.style.display = isParent ? 'grid' : 'none';

            // Din谩micamente actualizamos las etiquetas para mayor claridad
            document.getElementById('labelDni').innerText = isParent ? "DNI del Padre (Usuario):" : "DNI del Docente:";
            document.getElementById('labelName').innerText = isParent ? "Nombre Completo del Hijo:" : "Nombre Completo:";
            document.getElementById('uName').placeholder = isParent ? "Ej: Carlos Herrera P茅rez" : "Ej: Prof. Juan Lopez";
        });

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dni = document.getElementById('uDni').value.trim();
            const role = roleSelect.value;
            const name = document.getElementById('uName').value.trim();
            const pass = document.getElementById('uPass').value.trim();
            const studentDni = document.getElementById('uStudentDni').value.trim();

            // Generamos el correo institucional interno basado en el DNI del PADRE
            const email = `${dni}@genaroherrera.edu.pe`;

            const btn = userForm.querySelector('button');
            btn.disabled = true;
            btn.innerText = 'Registrando...';

            try {
                const userData = {
                    dni: dni,
                    name: name,
                    email: email,
                    role: role === 'students' ? 'parent' : 'teacher',
                    timestamp: new Date()
                };

                if (role === 'students') {
                    userData.studentName = name; // Assuming name is pupil name for simplicity in this demo
                    userData.grade = document.getElementById('uGrade').value;
                    userData.section = document.getElementById('uSection').value;
                    userData.studentDni = studentDni; // Guardamos el DNI del hijo
                    userData.attendance = "100";
                    userData.average = "18";
                    userData.rank = "1";
                }

                // Save using a composite ID or AddDoc to avoid overwriting multiple children
                let docId = email;
                if (role === 'students') {
                    // Unique ID per child for the same parent
                    docId = `${email}_${name.replace(/\s+/g, '_').toLowerCase()}`;
                }

                await setDoc(doc(db, role, docId), userData);

                alert("隆Usuario registrado exitosamente!");
                userForm.reset();
                parentFields.style.display = 'grid'; // Default
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'Registrar Usuario';
            }
        });

        // --- Conduct Form Logic ---
        const conductForm = document.getElementById('conductForm');
        conductForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const parentEmail = document.getElementById('parentEmail').value.toLowerCase().trim();
            if (!parentEmail) {
                alert("Por favor, ingrese el Correo del Padre arriba primero.");
                return;
            }

            const date = document.getElementById('cDate').value;
            const type = document.getElementById('cType').value;
            const desc = document.getElementById('cDesc').value;

            const btn = conductForm.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = 'Registrando...';
            btn.disabled = true;

            try {
                // Add to sub-collection "conduct"
                await addDoc(collection(db, "students", parentEmail, "conduct"), {
                    date: date,
                    type: type,
                    description: desc,
                    timestamp: new Date()
                });

                alert("Reporte de conducta registrado exitosamente.");
                conductForm.reset();
                // Reset date to today
                document.getElementById('cDate').valueAsDate = new Date();

            } catch (error) {
                console.error("Error adding conduct report: ", error);
                alert("Error al registrar: " + error.message);
            }

            btn.innerText = originalText;
            btn.disabled = false;
        });

        // Initialize date picker to today
        document.getElementById('cDate').valueAsDate = new Date();

        // --- BULK UPLOAD LOGIC ---

        // 1. Download Template (CSV Native - No Library Required)
        document.getElementById('downloadTplBtn').addEventListener('click', () => {
            try {
                // BOM for Excel to read UTF-8 correctly
                const BOOM = "\uFEFF";
                const csvContent = BOOM + "DNI,TIPO,DETALLE\n" +
                    "12345678,M茅rito,Participaci贸n destacada en clase\n" +
                    "87654321,Tardanza,Lleg贸 15 minutos tarde";

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "Plantilla_Conducta_GH.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                console.error("Error creating scv:", e);
                alert("Error generando la plantilla: " + e.message);
            }
        });

        // 2. Process File
        document.getElementById('processBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('bulkFile');
            const logBox = document.getElementById('consoleLog');

            if (fileInput.files.length === 0) return alert("Seleccione un archivo primero.");

            const file = fileInput.files[0];
            const reader = new FileReader();

            // UI Reset
            logBox.style.display = 'block';
            logBox.innerHTML = '> Iniciando lectura de archivo...<br>';
            const btn = document.getElementById('processBtn');
            btn.disabled = true;
            btn.style.opacity = '0.7';

            reader.onload = async (e) => {
                try {
                    let jsonData = [];

                    // Detect File Type
                    if (file.name.endsWith('.csv')) {
                        // Parse CSV Manually
                        const text = new TextDecoder("utf-8").decode(new Uint8Array(e.target.result));
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            const cols = lines[i].split(',');
                            if (cols.length < 1) continue;

                            let row = {};
                            // Simple mapping assuming 3 columns: DNI, TIPO, DETALLE
                            row['DNI'] = cols[0] ? cols[0].trim() : null;
                            row['TIPO'] = cols[1] ? cols[1].trim() : null;
                            row['DETALLE'] = cols[2] ? cols[2].trim() : null;
                            jsonData.push(row);
                        }

                    } else {
                        // Assume XLSX
                        if (typeof XLSX === 'undefined') {
                            throw new Error("Librer铆a XLSX no cargada. Use formato CSV o verifique conexi贸n.");
                        }
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    }

                    logBox.innerHTML += `> Filas encontradas: ${jsonData.length}<br>`;
                    logBox.innerHTML += `> Procesando... (No cierre la ventana)<br>--------------------------<br>`;

                    let successCount = 0;
                    let failCount = 0;

                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const dni = row.DNI ? row.DNI.toString().trim() : null;
                        const type = row.TIPO || "Observaci贸n";
                        const desc = row.DETALLE || "Sin detalles";

                        if (!dni) {
                            logBox.innerHTML += `<span style="color:orange;">[Fila ${i + 2}] Saltada: Sin DNI</span><br>`;
                            continue;
                        }

                        // Reverse Lookup: Find parent email by DNI
                        try {
                            const q = query(collection(db, "students"), where("dni", "==", dni), limit(1));
                            const snap = await getDocs(q);

                            if (snap.empty) {
                                logBox.innerHTML += `<span style="color:red;">[${dni}] Error: No registrado en Intranet (Sin Tutor)</span><br>`;
                                failCount++;
                            } else {
                                const parentDoc = snap.docs[0];
                                const parentEmail = parentDoc.id; // Correct ID

                                // Add Conduct Report
                                await addDoc(collection(db, "students", parentEmail, "conduct"), {
                                    date: new Date().toISOString().split('T')[0], // Today
                                    type: type,
                                    description: desc,
                                    timestamp: new Date(),
                                    method: 'bulk_excel'
                                });

                                logBox.innerHTML += `<span style="color:#0f0;">[${dni}] OK: Registrado a ${parentEmail}</span><br>`;
                                successCount++;
                            }
                        } catch (err) {
                            logBox.innerHTML += `<span style="color:red;">[${dni}] Error DB: ${err.message}</span><br>`;
                            failCount++;
                        }

                        // Scroll to bottom
                        logBox.scrollTop = logBox.scrollHeight;
                    }

                    logBox.innerHTML += `--------------------------<br>`;
                    logBox.innerHTML += `> FINALIZADO. xitos: ${successCount} | Fallos: ${failCount}<br>`;
                    alert(`Proceso completado.\nExitosos: ${successCount}\nFallidos: ${failCount}`);

                } catch (err) {
                    console.error(err);
                    alert("Error cr铆tico leyendo el Excel: " + err.message);
                }

                btn.disabled = false;
                btn.style.opacity = '1';
            };

            reader.readAsArrayBuffer(file);
        });
    </script>
</body>

</html>