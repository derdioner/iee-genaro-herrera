<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEVICHERIA 21 - Caja</title>
    <link rel="stylesheet" href="style.css?v=force">
    <link rel="icon" href="logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

    <header>
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="logo.png" style="height: 50px; border-radius: 5px;">
            <div>
                <h1>üíª Caja / Cocina</h1>
                <p style="margin: 0; color: #666; font-size: 14px;">CEVICHERIA 21 ‚Ä¢ Panel de Control</p>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="openReport()" class="btn-report">üìä VER REPORTE DEL D√çA</button>
            <a href="index.html" class="btn-secondary"
                style="padding: 10px 20px; border-radius: 50px; text-decoration: none;">Salir</a>
        </div>
    </header>

    <div class="dashboard-stats">
        <div class="stat-card stat-blue">
            <h3>Mesas Ocupadas</h3>
            <div class="value" id="statOccupied">-</div>
            <i style="font-style: normal;">üçΩÔ∏è</i>
        </div>
        <div class="stat-card stat-orange">
            <h3>Ventas Hoy</h3>
            <div class="value" id="statSales">S/ 0.00</div>
            <i style="font-style: normal;">üí∞</i>
        </div>
    </div>

    <h3 style="margin-bottom: 15px; color: #444;">Estado de Mesas</h3>
    <div class="grid-mesas" id="gridMesas">
        <!-- JS generates tables here -->
    </div>

    <div style="text-align: center; margin-bottom: 30px;">
        <button onclick="forceUpdateSystem()"
            style="background: transparent; border: 1px solid #ccc; padding: 10px; border-radius: 5px; cursor: pointer; color: #666;">
            üîÑ ACTUALIZAR SISTEMA
        </button>
    </div>

    <!-- BILLING MODAL -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Cuenta Mesa X</h2>

            <div id="billDetails" style="flex: 1; overflow-y: auto;">
                <!-- List -->
            </div>

            <h1 style="text-align: right; color: var(--primary);" id="billTotal">Total: S/ 0.00</h1>

            <div class="order-actions">
                <button class="btn-secondary" style="background:#e53935; color: white;" onclick="closeTable()">üóëÔ∏è
                    CERRAR MESA</button>
                <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn-primary" style="background:#FFA000;" onclick="printComanda()">üë®‚Äçüç≥ COMANDA</button>
                <button class="btn-primary" onclick="printBill()">üñ®Ô∏è IMPRIMIR CUENTA</button>
            </div>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-top: 0;">üìä Reporte de Ventas (Hoy)</h2>
            <div
                style="background: #f4f6f8; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                <p style="margin: 0; color: #666;">Total Recaudado</p>
                <h1 style="margin: 5px 0; color: #2E7D32; font-size: 40px;" id="reportTotalRevenue">S/ 0.00</h1>
                <p style="margin: 0; font-size: 14px; color: #888;" id="reportSalesCount">0 ventas realizadas</p>
            </div>

            <h3 style="margin-bottom: 10px;">Productos M√°s Vendidos</h3>
            <div style="flex: 1; overflow-y: auto;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th style="text-align: right;">Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="reportProductsBody">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>

            <button class="btn-secondary" onclick="closeModal()" style="margin-top: 20px; width: 100%;">Cerrar
                Reporte</button>
        </div>
    </div>

    <!-- PRINT TEMPLATE (Hidden from screen, visible in print) -->
    <div id="ticket-print-area" style="visibility: hidden;">
        <div class="ticket">
            <img id="printLogo" src="https://cdn-icons-png.flaticon.com/512/3081/3081840.png" style="width: 50px;">
            <h3 id="printHeader">CEVICHER√çA 21</h3>
            <p id="printSubheader">Av. Del Mar 123, Contamana</p>
            <p>--------------------------------</p>
            <p id="printMesa">MESA: X</p>
            <p id="printDate">FECHA: --/--/--</p>
            <p>--------------------------------</p>
            <div id="printItems" style="text-align: left;">
                <!-- Items go here -->
            </div>
            <p>--------------------------------</p>
            <div class="total" id="printTotal">TOTAL: S/ 0.00</div>

            <div id="printFooter">
                <p>Escanea para Yapear:</p>
                <!-- QR IMAGE -->
                <img src="yape_qr.png" class="qr" alt="QR Yape">
                <p>¬°Gracias por su preferencia!</p>
            </div>
            <br><br>.
        </div>
    </div>

    <script src="script.js?v=force"></script>
    <script>
        const grid = document.getElementById('gridMesas');
        const modal = document.getElementById('billModal');
        const reportModal = document.getElementById('reportModal');
        let currentMesaId = null;

        function renderTables() {
            const db = getDB();
            let occupiedCount = 0;

            grid.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                const key = `mesa_${i}`;
                const mesa = db[key];

                // Card UI
                const card = document.createElement('div');
                card.className = `card-mesa ${mesa.status}`;
                card.innerHTML = `
                    <div style="font-size: 30px;">${mesa.status === 'free' ? '‚úÖ' : 'üî¥'}</div>
                    MESA ${i}
                    <div style="font-size: 14px; margin-top: 5px;">${mesa.status === 'free' ? 'Libre' : formatMoney(mesa.total)}</div>
                `;

                if (mesa.status === 'occupied') {
                    occupiedCount++;
                    card.onclick = () => openBill(i);
                }

                grid.appendChild(card);
            }

            // --- UPDATE STATS ---
            const statOccupied = document.getElementById('statOccupied');
            if (statOccupied) statOccupied.innerText = occupiedCount;

            const report = getDailyReport();
            const statSales = document.getElementById('statSales');
            if (statSales) statSales.innerText = formatMoney(report.totalRevenue);
        }

        function openBill(id) {
            const db = getDB();
            const mesa = db[`mesa_${id}`];
            currentMesaId = id;

            document.getElementById('modalTitle').innerText = `Cuenta Mesa ${id}`;
            document.getElementById('billDetails').innerHTML = mesa.items.map(item => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:10px 0;">
                    <span>${item.name} ${item.printed ? '<span style="font-size:10px; color:green;">(En cocina)</span>' : '<span style="font-size:10px; color:red;">(NUEVO)</span>'}</span>
                    <span>${formatMoney(item.price)}</span>
                </div>
            `).join('');
            document.getElementById('billTotal').innerText = `Total: ${formatMoney(mesa.total)}`;


            modal.style.display = 'flex';
        }

        function openReport() {
            const report = getDailyReport();
            document.getElementById('reportTotalRevenue').innerText = formatMoney(report.totalRevenue);
            document.getElementById('reportSalesCount').innerText = `${report.salesCount} ventas realizadas`;

            const tbody = document.getElementById('reportProductsBody');

            // Convert to array and sort by count (descending)
            const products = Object.keys(report.productCounts)
                .sort((a, b) => report.productCounts[b] - report.productCounts[a]);

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999;">No hay ventas hoy</td></tr>';
            } else {
                tbody.innerHTML = products.map(name => {
                    const count = report.productCounts[name];
                    const details = report.productDetails[name] || []; // Fallback to empty array just in case

                    // Format details: "Mesa 1 (12:30), Mesa 2 (12:45)"
                    const detailHtml = details.map(d =>
                        `<span style="display:inline-block; background:#e3f2fd; color:#0d47a1; padding:2px 6px; border-radius:4px; margin:2px; font-size:11px;">Mesa ${d.mesa} - ${d.time}</span>`
                    ).join(' ');

                    return `
                    <tr>
                        <td>
                            <div style="font-weight:bold;">${name}</div>
                            <div style="margin-top:4px;">${detailHtml}</div>
                        </td>
                        <td style="text-align: right; vertical-align:top; font-weight: bold; font-size:16px;">${count}</td>
                    </tr>
                    `;
                }).join('');
            }

            reportModal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
            reportModal.style.display = 'none';
        }

        function closeTable() {
            if (!confirm('¬øSeguro que deseas cerrar la mesa y liberar el espacio?')) return;

            const db = getDB();
            const key = `mesa_${currentMesaId}`;

            // 1. SAVE TO HISTORY
            addToHistory(db[key]);

            // 2. RESET TABLE
            db[key].status = 'free';
            db[key].items = [];
            db[key].total = 0;
            saveDB(db);

            // 3. UI RESET
            closeModal();
            renderTables();
        }

        function printBill() {
            const db = getDB();
            const mesa = db[`mesa_${currentMesaId}`];

            // RESTORE STANDARD BILL
            document.getElementById('printHeader').innerText = 'CEVICHER√çA 21';
            document.getElementById('printSubheader').style.display = 'block';
            document.getElementById('printLogo').style.display = 'inline';
            document.getElementById('printTotal').style.display = 'block';
            document.getElementById('printFooter').style.display = 'block';

            document.getElementById('printMesa').innerText = `MESA: ${currentMesaId}`;
            document.getElementById('printDate').innerText = new Date().toLocaleString();
            document.getElementById('printItems').innerHTML = mesa.items.map(item => `
                <div style="display:flex; justify-content:space-between;">
                    <span>${item.name}</span>
                    <span>${item.price.toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('printTotal').innerText = `TOTAL: ${formatMoney(mesa.total)}`;

            window.print();
        }

        function printComanda() {
            const db = getDB();
            const key = `mesa_${currentMesaId}`;
            const mesa = db[key];

            // Filter UNPRINTED items
            const newItems = mesa.items.filter(item => !item.printed);

            if (newItems.length === 0) {
                alert('‚ö†Ô∏è No hay items nuevos para enviar a cocina.');
                return;
            }

            // CONFIGURE FOR KITCHEN
            document.getElementById('printHeader').innerText = 'üî• COMANDA COCINA üî•';
            document.getElementById('printSubheader').style.display = 'none';
            document.getElementById('printLogo').style.display = 'none';
            document.getElementById('printTotal').style.display = 'none'; // No total
            document.getElementById('printFooter').style.display = 'none'; // No QR

            document.getElementById('printMesa').innerText = `MESA: ${currentMesaId}`;
            document.getElementById('printDate').innerText = new Date().toLocaleTimeString(); // Only time matters

            // Group items for kitchen (e.g. 2x Ceviche)
            const summary = {};
            newItems.forEach(i => {
                summary[i.name] = (summary[i.name] || 0) + 1;
            });

            document.getElementById('printItems').innerHTML = Object.entries(summary).map(([name, count]) => `
                <div style="display:flex; justify-content:space-between; font-size: 20px; font-weight: bold; margin-bottom: 5px; border-bottom: 1px dashed black;">
                    <span>${count} x ${name}</span>
                </div>
            `).join('');

            window.print();

            // MARK AS PRINTED
            mesa.items.forEach(item => {
                // Determine if item is in newItems list (by reference or ID + addedAt)
                // Since we filtered from mesa.items, we can just iterate and mark.
                // Wait, filters create shallow copies of arrays but objects are references? Yes.
                if (!item.printed) {
                    item.printed = true;
                }
            });

            saveDB(db);
            openBill(currentMesaId); // Refresh modal to show "En cocina"
        }

        // Timer for auto-refresh
        setInterval(renderTables, 2000);

        // Initial render
        renderTables();
    </script>
</body>

</html>