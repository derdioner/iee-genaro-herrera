<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEVICHERIA 21 - Caja</title>
    <link rel="stylesheet" href="style.css?v=flex_fix_v4">
    <link rel="icon" href="logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

    <header>
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="logo.png" style="height: 50px; border-radius: 5px;">
            <div>
                <h1>üíª Caja / Cocina</h1>
                <p style="margin: 0; color: #666; font-size: 14px;">CEVICHERIA 21 ‚Ä¢ Panel de Control</p>
            </div>
        </div>

        <!-- MOVED STATS HERE -->
        <div class="dashboard-stats" style="margin: 0 20px;">
            <div class="stat-card stat-blue">
                <h3>Mesas Ocupadas</h3>
                <div class="value" id="statOccupied">-</div>
            </div>
            <div class="stat-card stat-orange">
                <h3>Ventas Hoy</h3>
                <div class="value" id="statSales">S/ 0.00</div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="forceUpdateSystem()" class="btn-secondary"
                style="background:transparent; border:1px solid rgba(0,0,0,0.1); color:#546E7A; padding:8px 15px; border-radius:50px; font-size:12px; display:flex; gap:5px; align-items:center;">
                üîÑ ACTUALIZAR
            </button>
            <button onclick="openReport()" class="btn-report">üìä REPORTE</button>
            <a href="index.html" class="btn-secondary"
                style="padding: 10px 20px; border-radius: 50px; text-decoration: none;">Salir</a>
        </div>
    </header>

    <div class="cashier-dashboard">
        <!-- LEFT: Tables 1-10 -->
        <div class="tables-column">
            <h3 style="margin-top:0; color:#546E7A;">Mesas 1 - 10</h3>
            <div class="grid-mesas-split" id="tablesLeft"></div>
        </div>

        <!-- CENTER: Action Panel -->
        <div class="action-panel" id="actionPanel">
            <div style="text-align:center; color:#999; margin-top: 50px;">
                <p style="font-size: 40px; margin-bottom: 10px;">üëà üëâ</p>
                <p>Seleccione una mesa<br>para ver el detalle</p>
            </div>
        </div>

        <!-- RIGHT: Tables 11-20 -->
        <div class="tables-column">
            <h3 style="margin-top:0; color:#546E7A;">Mesas 11 - 20</h3>
            <div class="grid-mesas-split" id="tablesRight"></div>
        </div>
    </div>



    <!-- BILLING MODAL -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Cuenta Mesa X</h2>

            <div id="billDetails" style="flex: 1; overflow-y: auto;">
                <!-- List -->
            </div>

            <h1 style="text-align: right; color: var(--primary);" id="billTotal">Total: S/ 0.00</h1>

            <div class="order-actions">
                <button class="btn-secondary" style="background:#e53935; color: white;" onclick="closeTable()">üóëÔ∏è
                    CERRAR MESA</button>
                <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn-primary" style="background:#FFA000;" onclick="printComanda()">üë®‚Äçüç≥ COMANDA</button>
                <button class="btn-primary" onclick="printBill()">üñ®Ô∏è IMPRIMIR CUENTA</button>
            </div>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-top: 0;">üìä Reporte de Ventas (Hoy)</h2>
            <div
                style="background: #f4f6f8; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px;">
                <p style="margin: 0; color: #666;">Total Recaudado</p>
                <h1 style="margin: 5px 0; color: #2E7D32; font-size: 40px;" id="reportTotalRevenue">S/ 0.00</h1>
                <p style="margin: 0; font-size: 14px; color: #888;" id="reportSalesCount">0 ventas realizadas</p>
            </div>

            <h3 style="margin-bottom: 10px;">Productos M√°s Vendidos</h3>
            <div style="flex: 1; overflow-y: auto;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th style="text-align: right;">Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="reportProductsBody">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>

            <button class="btn-secondary" onclick="closeModal()" style="margin-top: 20px; width: 100%;">Cerrar
                Reporte</button>
        </div>
    </div>

    <!-- PRINT TEMPLATE (Hidden from screen, visible in print) -->
    <div id="ticket-print-area" style="visibility: hidden;">
        <div class="ticket">
            <img id="printLogo" src="https://cdn-icons-png.flaticon.com/512/3081/3081840.png" style="width: 50px;">
            <h3 id="printHeader">CEVICHER√çA 21</h3>
            <p id="printSubheader">Av. Del Mar 123, Contamana</p>
            <p>--------------------------------</p>
            <p id="printMesa">MESA: X</p>
            <p id="printDate">FECHA: --/--/--</p>
            <p>--------------------------------</p>
            <div id="printItems" style="text-align: left;">
                <!-- Items go here -->
            </div>
            <p>--------------------------------</p>
            <div class="total" id="printTotal">TOTAL: S/ 0.00</div>

            <div id="printFooter">
                <p>Escanea para Yapear:</p>
                <!-- QR IMAGE -->
                <img src="yape_qr.png" class="qr" alt="QR Yape">
                <p>¬°Gracias por su preferencia!</p>
            </div>
            <br><br>.
        </div>
    </div>

    <script type="module">
        import './script.js?v=force';

        // Wait for script to load and DB to init
        window.onload = function () {
            setTimeout(() => {
                if (typeof renderTables === 'function') renderTables();
            }, 1000); // Small delay to allow Firestore to fetch
        };
    </script>
    <script>
        const reportModal = document.getElementById('reportModal');
        // Grid now split into tablesLeft and tablesRight
        let currentMesaId = null;

        function renderTables() {
            const db = getDB();
            let occupiedCount = 0;

            const leftContainer = document.getElementById('tablesLeft');
            const rightContainer = document.getElementById('tablesRight');

            if (!leftContainer || !rightContainer) return;

            leftContainer.innerHTML = '';
            rightContainer.innerHTML = '';

            for (let i = 1; i <= 20; i++) {
                const key = `mesa_${i}`;
                const mesa = db[key];

                // Card UI - Compact
                const card = document.createElement('div');
                card.className = `card-mesa ${mesa.status}`;
                if (currentMesaId === i) card.style.border = "3px solid var(--primary)";

                card.innerHTML = `
                    <div class="plate-icon ${mesa.status}">
                        <div class="plate-inner">
                            <span style="font-size: 24px;">${mesa.status === 'free' ? 'üçΩÔ∏è' : 'ü•ò'}</span>
                        </div>
                        <div class="plate-number">${i}</div>
                    </div>
                    <div style="margin-top: 4px;">
                        <span class="status-badge ${mesa.status}">
                            ${mesa.status === 'free' ? 'LIBRE' : formatMoney(mesa.total)}
                        </span>
                    </div>
                `;

                if (mesa.status === 'occupied') {
                    occupiedCount++;
                    card.onclick = () => openBill(i);
                } else {
                    card.style.opacity = "0.7"; // Dim free tables slightly
                }

                if (i <= 10) {
                    leftContainer.appendChild(card);
                } else {
                    rightContainer.appendChild(card);
                }
            }

            // --- UPDATE STATS ---
            const statOccupied = document.getElementById('statOccupied');
            if (statOccupied) statOccupied.innerText = occupiedCount;

            const report = getDailyReport();
            const statSales = document.getElementById('statSales');
            if (statSales) statSales.innerText = formatMoney(report.totalRevenue);

            // Refresh detail view if open
            if (currentMesaId && db[`mesa_${currentMesaId}`].status === 'occupied') {
                renderActionPanel(currentMesaId);
            } else if (currentMesaId && db[`mesa_${currentMesaId}`].status === 'free') {
                document.getElementById('actionPanel').innerHTML = `
                    <div style="text-align:center; color:#999; margin-top: 50px;">
                        <p style="font-size: 40px; margin-bottom: 10px;">‚úÖ</p>
                        <p>Mesa ${currentMesaId} liberada</p>
                    </div>`;
                currentMesaId = null;
            }
        }

        function openBill(id) {
            currentMesaId = id;
            renderActionPanel(id);
            renderTables(); // To highlight active border
        }

        function renderActionPanel(id) {
            const db = getDB();
            const mesa = db[`mesa_${id}`];
            const panel = document.getElementById('actionPanel');

            panel.innerHTML = `
                <div class="action-header" style="display:block; text-align:center;">
                    <h1 style="margin:0; font-size: 36px; color:var(--primary); text-transform:uppercase;">CUENTA MESA ${id}</h1>
                    <div style="font-size:40px; font-weight:800; color:#2E7D32; margin-top:5px;">
                        ${formatMoney(mesa.total)}
                    </div>
                </div>

                <div class="action-footer" style="border-top:none; border-bottom:2px solid #f5f5f5; padding-top:0; padding-bottom:15px; margin-bottom:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button onclick="closeTable()" style="background:#D32F2F; color:white; border:none; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; gap:5px;">
                        üóëÔ∏è CERRAR MESA
                    </button>
                    <button onclick="currentMesaId = null; renderTables();" style="background:#ECEFF1; color:#333; border:1px solid #CFD8DC; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; gap:5px;">
                        üö´ CANCELAR
                    </button>
                    <button onclick="printComanda()" style="background:#FBC02D; color:#333; border:none; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; gap:5px;">
                        üë®‚Äçüç≥ COCINA
                    </button>
                    <button onclick="printBill()" style="background:#fff; color:#1976D2; border:2px solid #1976D2; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; gap:5px;">
                        üñ®Ô∏è IMPRIMIR CUENTA
                    </button>
                </div>

                <div class="action-body">
                    ${mesa.items.length === 0 ? '<div style="text-align:center; padding:20px; color:#999;">Sin pedidos a√∫n</div>' : ''}
                    ${mesa.items.map(item => `
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:12px 0;">
                            <span>${item.name} 
                                ${item.printed ?
                    '<span style="font-size:11px; color:green; background:#e8f5e9; padding:2px 6px; border-radius:4px;">En cocina</span>' :
                    '<span style="font-size:11px; color:red; background:#ffebee; padding:2px 6px; border-radius:4px;">NUEVO</span>'}
                            </span>
                            <span style="font-weight:600;">${formatMoney(item.price)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openReport() {
            const report = getDailyReport();
            document.getElementById('reportTotalRevenue').innerText = formatMoney(report.totalRevenue);
            document.getElementById('reportSalesCount').innerText = `${report.salesCount} ventas realizadas`;

            const tbody = document.getElementById('reportProductsBody');

            // Convert to array and sort by count (descending)
            const products = Object.keys(report.productCounts)
                .sort((a, b) => report.productCounts[b] - report.productCounts[a]);

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#999;">No hay ventas hoy</td></tr>';
            } else {
                tbody.innerHTML = products.map(name => {
                    const count = report.productCounts[name];
                    const details = report.productDetails[name] || []; // Fallback to empty array just in case

                    // Format details: "Mesa 1 (12:30), Mesa 2 (12:45)"
                    const detailHtml = details.map(d =>
                        `<span style="display:inline-block; background:#e3f2fd; color:#0d47a1; padding:2px 6px; border-radius:4px; margin:2px; font-size:11px;">Mesa ${d.mesa} - ${d.time}</span>`
                    ).join(' ');

                    return `
                    <tr>
                        <td>
                            <div style="font-weight:bold;">${name}</div>
                            <div style="margin-top:4px;">${detailHtml}</div>
                        </td>
                        <td style="text-align: right; vertical-align:top; font-weight: bold; font-size:16px;">${count}</td>
                    </tr>
                    `;
                }).join('');
            }

            reportModal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
            reportModal.style.display = 'none';
        }

        function closeTable() {
            if (!confirm('¬øSeguro que deseas cerrar la mesa y liberar el espacio?')) return;

            const db = getDB();
            const key = `mesa_${currentMesaId}`;

            // 1. SAVE TO HISTORY
            addToHistory(db[key]);

            // 2. RESET TABLE
            db[key].status = 'free';
            db[key].items = [];
            db[key].total = 0;
            saveDB(db);

            // 3. UI RESET
            closeModal();
            renderTables();
        }

        function printBill() {
            const db = getDB();
            const mesa = db[`mesa_${currentMesaId}`];

            // RESTORE STANDARD BILL
            document.getElementById('printHeader').innerText = 'CEVICHER√çA 21';
            document.getElementById('printSubheader').style.display = 'block';
            document.getElementById('printLogo').style.display = 'inline';
            document.getElementById('printTotal').style.display = 'block';
            document.getElementById('printFooter').style.display = 'block';

            document.getElementById('printMesa').innerText = `MESA: ${currentMesaId}`;
            document.getElementById('printDate').innerText = new Date().toLocaleString();
            document.getElementById('printItems').innerHTML = mesa.items.map(item => `
                <div style="display:flex; justify-content:space-between;">
                    <span>${item.name}</span>
                    <span>${item.price.toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('printTotal').innerText = `TOTAL: ${formatMoney(mesa.total)}`;

            window.print();
        }

        function printComanda() {
            const db = getDB();
            const key = `mesa_${currentMesaId}`;
            const mesa = db[key];

            // Filter UNPRINTED items
            const newItems = mesa.items.filter(item => !item.printed);

            if (newItems.length === 0) {
                alert('‚ö†Ô∏è No hay items nuevos para enviar a cocina.');
                return;
            }

            // CONFIGURE FOR KITCHEN
            document.getElementById('printHeader').innerText = 'üî• COMANDA COCINA üî•';
            document.getElementById('printSubheader').style.display = 'none';
            document.getElementById('printLogo').style.display = 'none';
            document.getElementById('printTotal').style.display = 'none'; // No total
            document.getElementById('printFooter').style.display = 'none'; // No QR

            document.getElementById('printMesa').innerText = `MESA: ${currentMesaId}`;
            document.getElementById('printDate').innerText = new Date().toLocaleTimeString(); // Only time matters

            // Group items for kitchen (e.g. 2x Ceviche)
            const summary = {};
            newItems.forEach(i => {
                summary[i.name] = (summary[i.name] || 0) + 1;
            });

            document.getElementById('printItems').innerHTML = Object.entries(summary).map(([name, count]) => `
                <div style="display:flex; justify-content:space-between; font-size: 20px; font-weight: bold; margin-bottom: 5px; border-bottom: 1px dashed black;">
                    <span>${count} x ${name}</span>
                </div>
            `).join('');

            window.print();

            // MARK AS PRINTED
            mesa.items.forEach(item => {
                // Determine if item is in newItems list (by reference or ID + addedAt)
                // Since we filtered from mesa.items, we can just iterate and mark.
                // Wait, filters create shallow copies of arrays but objects are references? Yes.
                if (!item.printed) {
                    item.printed = true;
                }
            });

            saveDB(db);
            openBill(currentMesaId); // Refresh modal to show "En cocina"
        }

        // Timer for auto-refresh
        setInterval(renderTables, 2000);

        // Initial render
        renderTables();
    </script>
</body>

</html>